trigger:
  branches:
    include:
      - main
      - dev
      - uat  # é€™äº›åˆ†æ”¯æœ‰è®Šæ›´æ™‚æœƒåŸ·è¡Œå®Œæ•´ Pipeline

pr:
  branches:
    include:
      - main
      - dev
      - uat  # PR åªåŸ·è¡Œ CIï¼ˆæ¸¬è©¦ã€Lintï¼‰ï¼Œä¸é€²è¡Œéƒ¨ç½²

pool:
  name: 'Default'  # ä½ çš„ Self-hosted Agent Pool

steps:
  - script: |
      echo "Checking Python installation..."
      python3 --version
      which python3
    displayName: 'Check Python Version'

  - script: |
      echo "Creating Python Virtual Environment..."
      python3 -m venv venv  # å»ºç«‹è™›æ“¬ç’°å¢ƒ
      source venv/bin/activate  # å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
      echo "Upgrading pip and installing dependencies..."
      python -m pip install --upgrade pip
      python -m pip install -r flask_app/requirements.txt  # å®‰è£ä¾è³´
    displayName: 'Install Dependencies'

  - script: |
      echo "Running flake8 linting..."
      source venv/bin/activate  # ç¢ºä¿ä½¿ç”¨è™›æ“¬ç’°å¢ƒ
      flake8 flask_app  # æª¢æŸ¥ flask_app ç›®éŒ„ä¸­çš„æ‰€æœ‰ Python æª”æ¡ˆ
    displayName: 'Run Linting'
    continueOnError: true  # å¦‚æœ Linting å¤±æ•—ï¼Œä»ç¹¼çºŒ

  - script: |
      echo "Running PyLint..."
      source venv/bin/activate
      pylint flask_app
    displayName: 'Run PyLint'
    continueOnError: true

  - script: |
      echo "Starting Flask App..."
      source venv/bin/activate  # ç¢ºä¿ä½¿ç”¨è™›æ“¬ç’°å¢ƒ
      export FLASK_APP=flask_app.app  # è¨­ç½® FLASK_APP ç’°å¢ƒè®Šæ•¸
      flask run --host=0.0.0.0 --port=5001 &  # å•Ÿå‹• Flask æ‡‰ç”¨
      sleep 10  # ç­‰å¾… Flask å•Ÿå‹•
      curl -v http://127.0.0.1:5001/  # é©—è­‰ API
    displayName: 'Start Flask & Check API'

  - script: |
      echo "Running API Tests..."
      source venv/bin/activate  # ç¢ºä¿ä½¿ç”¨è™›æ“¬ç’°å¢ƒ
      export PYTHONPATH=$(pwd)  # ç¢ºä¿ pytest èƒ½æ‰¾åˆ° flask_app
      echo "PYTHONPATH is set to $PYTHONPATH"
      pytest -v flask_app/tests/test_routes.py  # æŒ‡å®šæ¸¬è©¦æª”æ¡ˆ
    displayName: 'Run API Tests'

  - script: |
      echo "Stopping Flask App..."
      pkill -f flask || echo "Flask process not found"  # åœæ­¢ Flask æ‡‰ç”¨
    displayName: 'Stop Flask App'

  # **ğŸ”¹ å…ˆæ¸…é™¤ `__pycache__` å’Œ `.pyc`ï¼Œç¢ºä¿ä¸è¢«æ‰“åŒ…**
  - script: |
      echo "Cleaning up __pycache__ and .pyc files before packaging..."
      find flask_app -name "__pycache__" -type d -exec rm -rf {} +
      find flask_app -name "*.pyc" -type f -delete
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    displayName: 'Clean up __pycache__ and .pyc files (Before Packaging)'

  # **ğŸ”¹ åªåœ¨ Merge æ™‚æ‰“åŒ… & éƒ¨ç½²**
  - task: ArchiveFiles@2
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)/flask_app'
      includeRootFolder: true
      archiveFile: '$(Build.ArtifactStagingDirectory)/flask_app.zip'
      replaceExistingArchive: true
      verbose: true
      exclude: |
        **/__pycache__/**
        **/*.pyc
    displayName: 'Archive flask_app folder (Only on Merge)'

  - task: AzureWebApp@1
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      azureSubscription: 'twlife_azure_devops_poc'  # æ‚¨å‰µå»ºçš„ Service Connection åç¨±
      appName: 'twlife-azure-devops-poc'  # æ‚¨çš„ Azure App Service åç¨±
      package: '$(Build.ArtifactStagingDirectory)/flask_app.zip'  # æŒ‡å‘æ‰“åŒ…å¥½çš„ ZIP æª”
    displayName: 'Deploy to Azure App Service (Only on Merge)'

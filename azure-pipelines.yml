trigger:
  branches:
    include:
      - main
      - dev
      - uat

pr:
  branches:
    include:
      - main
      - dev
      - uat

pool:
  name: 'Default'

steps:
  - script: |
      echo "Checking Python installation..."
      python3 --version
      which python3
    displayName: 'Check Python Version'

  - script: |
      echo "Creating Python Virtual Environment..."
      python3 -m venv venv  # å»ºç«‹è™›æ“¬ç’°å¢ƒ
      source venv/bin/activate  # å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
      echo "Upgrading pip and installing dependencies..."
      python -m pip install --upgrade pip
      python -m pip install -r flask_app/requirements.txt  # å®‰è£ä¾è³´
    displayName: 'Install Dependencies'

  - script: |
      echo "Running flake8 linting..."
      source venv/bin/activate  # ç¢ºä¿ä½¿ç”¨è™›æ“¬ç’°å¢ƒ
      flake8 flask_app  # æª¢æŸ¥ flask_app ç›®éŒ„ä¸­çš„æ‰€æœ‰ Python æª”æ¡ˆ
    displayName: 'Run Flake8'
    continueOnError: true

  - script: |
      echo "Running PyLint..."
      source venv/bin/activate
      pylint flask_app
    displayName: 'Run PyLint'
    continueOnError: true

  - script: |
      echo "Starting Flask App..."
      source venv/bin/activate  # ç¢ºä¿ä½¿ç”¨è™›æ“¬ç’°å¢ƒ
      export FLASK_APP=flask_app.app  # è¨­ç½® FLASK_APP ç’°å¢ƒè®Šæ•¸
      flask run --host=0.0.0.0 --port=5001 &  # å•Ÿå‹• Flask æ‡‰ç”¨
      sleep 10  # ç­‰å¾… Flask å•Ÿå‹•
      curl -v http://127.0.0.1:5001/  # é©—è­‰ API
    displayName: 'Start Flask & Check API'

  - script: |
      echo "Running API Tests..."
      source venv/bin/activate  # ç¢ºä¿ä½¿ç”¨è™›æ“¬ç’°å¢ƒ
      export PYTHONPATH=$(pwd)  # ç¢ºä¿ pytest èƒ½æ‰¾åˆ° flask_app
      echo "PYTHONPATH is set to $PYTHONPATH"
      pytest -v flask_app/tests/test_routes.py  # æŒ‡å®šæ¸¬è©¦æª”æ¡ˆ
    displayName: 'Run API Tests'

  - script: |
      echo "Stopping Flask App..."
      pkill -f flask || echo "Flask process not found"  # åœæ­¢ Flask æ‡‰ç”¨
    displayName: 'Stop Flask App'

  # **ğŸ”¹ ç¢ºä¿ requirements.txt åœ¨æ ¹ç›®éŒ„**
  - script: |
      echo "Copying requirements.txt to root directory..."
      cp flask_app/requirements.txt .
    displayName: 'Move requirements.txt to root'

  # **ğŸ”¹ ç¢ºä¿ requirements.txt ç¢ºå¯¦å­˜åœ¨**
  - script: |
      echo "Checking if requirements.txt exists..."
      if [ -f requirements.txt ]; then
        echo "âœ… Found requirements.txt in root directory."
      else
        echo "âŒ requirements.txt NOT found in root directory!"
        exit 1
      fi
    displayName: 'Check if requirements.txt exists before packaging'

  - task: ArchiveFiles@2
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      rootFolderOrFile: '.'
      includeRootFolder: false
      archiveFile: '$(Build.ArtifactStagingDirectory)/flask_app.zip'
      replaceExistingArchive: true
      verbose: true
      contents: |
        flask_app/**
        requirements.txt
      exclude: |
        **/.git/**        
        **/.gitignore     
        **/.flake8        
        **/LICENSE        
        **/README.md      
        **/azure-pipelines.yml  
        **/venv/**        
        **/__pycache__/** 
        **/*.pyc         
    displayName: 'Archive flask_app + requirements.txt (Only on Merge)'


  # **ğŸ”¹ ç¢ºä¿ App Service å…§éƒ¨æœƒåŸ·è¡Œ pip install**
  - task: AzureWebApp@1
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      azureSubscription: 'twlife_azure_devops_poc'
      appName: 'twlife-azure-devops-poc'
      package: '$(Build.ArtifactStagingDirectory)/flask_app.zip'
      appSettings: |
        -SCM_DO_BUILD_DURING_DEPLOYMENT 1
    displayName: 'Deploy to Azure App Service (Only on Merge)'

  # **ğŸ”¹ æª¢æŸ¥ Flask æ˜¯å¦æˆåŠŸå•Ÿå‹•**
  - script: |
      echo "Checking if Flask is running on App Service..."
      HEALTH_URL="https://twlife-azure-devops-poc-gtgtach8gcfreyhj.eastasia-01.azurewebsites.net/health"
      for i in {1..10}; do
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" $HEALTH_URL)
          if [ "$HTTP_CODE" -eq 200 ]; then
              echo "Flask is up and running at $HEALTH_URL!"
              exit 0
          fi
          echo "Health check failed with status $HTTP_CODE, retrying in 5s..."
          sleep 5
      done
      echo "Flask service did not start in time. Failing deployment."
      exit 1
    displayName: 'Check Flask Health (Post Deployment)'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
